<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Copec TCT | App</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0033A0">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --brand-red: #DA291C;
            --brand-blue: #0033A0;
            --brand-dark-blue: #001f60;
            --whatsapp: #25D366;
            --gold: #ffc107;
            
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-sec: #6c757d;
            --shadow: 0 8px 20px rgba(0,0,0,0.06);
            --border-color: #f0f0f0;
            --glass-bg: rgba(255, 255, 255, 0.95);
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sec: #a0a0a0;
            --shadow: 0 8px 20px rgba(0,0,0,0.4);
            --border-color: #333;
            --glass-bg: rgba(30, 30, 30, 0.95);
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-body);
            margin: 0;
            color: var(--text-main);
            padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--brand-blue) 0%, var(--brand-dark-blue) 100%);
            color: white;
            padding: 30px 20px 90px 20px;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            position: relative;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            margin: 0; font-size: 1.5rem;
            display: flex; align-items: center; gap: 10px;
        }

        .header-actions { display: flex; gap: 10px; }

        .icon-btn {
            background: rgba(255,255,255,0.2); border: none; color: white;
            width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; backdrop-filter: blur(5px);
        }

        /* Panel de Control */
        .control-panel {
            max-width: 700px; margin: -70px auto 20px auto; padding: 20px;
            position: relative; z-index: 10;
            background: var(--glass-bg); backdrop-filter: blur(10px);
            border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; gap: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Tabs de Navegaci√≥n (Buscar / Favoritos) */
        .nav-tabs {
            display: flex; background: var(--bg-body);
            padding: 5px; border-radius: 12px; margin-bottom: 5px;
        }

        .nav-tab {
            flex: 1; padding: 10px; text-align: center;
            border-radius: 10px; font-size: 0.9rem; font-weight: 600;
            color: var(--text-sec); cursor: pointer;
        }

        .nav-tab.active {
            background: white; color: var(--brand-blue);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        [data-theme="dark"] .nav-tab.active { background: #333; color: white; }

        /* Inputs */
        .search-wrapper {
            position: relative; background: var(--bg-body); border-radius: 16px;
            display: flex; align-items: center; border: 2px solid transparent;
        }
        .search-wrapper:focus-within { border-color: var(--brand-blue); }
        .search-icon { padding-left: 15px; color: var(--brand-blue); }
        .search-input {
            flex: 1; padding: 16px 10px; border: none; border-radius: 16px;
            font-size: 1rem; outline: none; background: transparent; color: var(--text-main);
            font-family: 'Outfit', sans-serif;
        }
        .clear-btn { padding: 10px 15px; color: var(--text-sec); cursor: pointer; display: none; }

        .region-select {
            width: 100%; padding: 14px 15px; border: none; border-radius: 12px;
            font-size: 0.95rem; background: var(--bg-body); color: var(--text-main);
            outline: none; cursor: pointer;
        }

        /* Chips Filtros */
        .quick-filters { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-chip {
            background: var(--bg-body); padding: 8px 16px; border-radius: 25px;
            font-size: 0.85rem; color: var(--text-sec); cursor: pointer; white-space: nowrap;
            transition: all 0.2s; font-weight: 500; border: 1px solid transparent;
        }
        .filter-chip.active { background: var(--brand-blue); color: white; box-shadow: 0 4px 12px rgba(0, 51, 160, 0.3); }

        .results-count { text-align: center; font-size: 0.85rem; color: var(--text-sec); font-weight: 600; margin-top: 5px; }

        /* Tarjetas */
        .container { max-width: 800px; margin: 0 auto; padding: 0 15px; }

        .card {
            background: var(--bg-card); border-radius: 20px; box-shadow: var(--shadow);
            border: 1px solid var(--border-color); padding: 20px; margin-bottom: 15px;
            position: relative; transition: transform 0.3s;
        }
        .card:hover { transform: translateY(-3px); }

        .card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .card-comuna { font-weight: 700; color: var(--brand-blue); font-size: 1.15rem; }
        [data-theme="dark"] .card-comuna { color: #4da3ff; }
        .card-region { font-size: 0.7rem; background: var(--bg-body); padding: 4px 10px; border-radius: 8px; color: var(--text-sec); font-weight: 600; text-transform: uppercase; }

        /* Bot√≥n Favorito */
        .fav-btn {
            background: none; border: none; cursor: pointer; font-size: 1.4rem;
            color: #ddd; transition: transform 0.2s, color 0.2s; padding: 0 0 0 10px;
        }
        .fav-btn.is-fav { color: var(--gold); }
        .fav-btn:active { transform: scale(1.3); }

        .card-address { color: var(--text-main); font-size: 0.95rem; margin-bottom: 15px; display: flex; align-items: start; gap: 8px; }
        .card-services { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 20px; }
        
        .tag { font-size: 0.75rem; padding: 5px 10px; border-radius: 8px; font-weight: 500; }
        .tag-tct { background: rgba(218, 41, 28, 0.1); color: var(--brand-red); border: 1px solid rgba(218, 41, 28, 0.2); }
        [data-theme="dark"] .tag-tct { background: rgba(218, 41, 28, 0.2); color: #ff6b6b; }
        .tag-other { background: var(--bg-body); color: var(--text-sec); }

        .card-actions { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; }
        .btn {
            padding: 12px; border-radius: 12px; text-decoration: none; font-weight: 600;
            font-size: 0.95rem; text-align: center; display: flex; align-items: center;
            justify-content: center; gap: 8px; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-call { background: var(--bg-body); color: var(--text-main); }
        .btn-map { background: var(--brand-blue); color: white; box-shadow: 0 4px 15px rgba(0, 51, 160, 0.25); }
        .btn-wsp { background: var(--whatsapp); color: white; width: 50px; font-size: 1.3rem; padding: 0; }

        .no-results { text-align: center; padding: 50px; color: var(--text-sec); }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <h1><i class="fas fa-gas-pump"></i> Red TCT</h1>
        <div class="header-actions">
            <button class="icon-btn" onclick="shareApp()" title="Compartir App"><i class="fas fa-share-nodes"></i></button>
            <button class="icon-btn" id="themeToggle" onclick="toggleTheme()" title="Modo Oscuro"><i class="fas fa-moon"></i></button>
        </div>
    </div>
</header>

<div class="control-panel">
    <div class="nav-tabs">
        <div class="nav-tab active" id="tabSearch" onclick="switchTab('search')">üîç Buscar</div>
        <div class="nav-tab" id="tabFavs" onclick="switchTab('favs')">‚≠ê Favoritos</div>
    </div>

    <div id="searchControls">
        <div class="search-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Comuna, direcci√≥n...">
            <i class="fas fa-times-circle clear-btn" id="clearBtn"></i>
        </div>

        <div style="margin-top: 10px;">
            <select id="regionFilter" class="region-select">
                <option value="">Todas las Regiones</option>
            </select>
        </div>

        <div class="quick-filters" style="margin-top: 10px;">
            <div class="filter-chip" onclick="toggleQuickFilter('VOLTEX', this)"><i class="fas fa-bolt"></i> Voltex</div>
            <div class="filter-chip" onclick="toggleQuickFilter('BLUEMAX', this)"><i class="fas fa-truck"></i> BlueMax</div>
            <div class="filter-chip" onclick="toggleQuickFilter('TAE', this)"><i class="fas fa-credit-card"></i> TAE</div>
        </div>
    </div>
    
    <div id="countInfo" class="results-count">Cargando...</div>
</div>

<div class="container" id="resultsContainer"></div>

<script src="datos.js"></script>

<script>
    let stations = [];
    let uniqueRegions = new Set();
    let activeServiceFilter = ""; 
    let currentTab = 'search'; // 'search' o 'favs'
    let favorites = JSON.parse(localStorage.getItem('copecFavorites')) || [];

    // --- UTILIDADES ---
    function limpiarTexto(texto) {
        if (!texto) return "";
        return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }

    function shareApp() {
        if (navigator.share) {
            navigator.share({
                title: 'Buscador Copec TCT',
                text: 'Te comparto esta herramienta para buscar estaciones Copec TCT:',
                url: window.location.href
            });
        } else {
            alert("Copia este enlace: " + window.location.href);
        }
    }

    // --- MODO OSCURO ---
    function toggleTheme() {
        const body = document.body;
        const btn = document.getElementById('themeToggle');
        const isDark = body.getAttribute('data-theme') === 'dark';
        
        if (isDark) {
            body.removeAttribute('data-theme');
            btn.innerHTML = '<i class="fas fa-moon"></i>';
            localStorage.setItem('theme', 'light');
        } else {
            body.setAttribute('data-theme', 'dark');
            btn.innerHTML = '<i class="fas fa-sun"></i>';
            localStorage.setItem('theme', 'dark');
        }
    }
    if (localStorage.getItem('theme') === 'dark') toggleTheme();

    // --- CARGA DE DATOS ---
    window.onload = function() {
        if (typeof baseDeDatosCopec !== 'undefined') {
            processData(baseDeDatosCopec);
        } else {
            document.getElementById('countInfo').innerText = "Error: Falta datos.js";
        }
    };

    function processData(csvText) {
        const lines = csvText.split(/\r\n|\n/);
        let currentRegion = "Sin Regi√≥n";

        lines.forEach((line, index) => {
            if(!line.trim()) return;
            const row = line.split(','); 
            if (row[1] && row[1].includes('Regi√≥n')) {
                currentRegion = row[1].trim().replace(/['"]+/g, '').replace("Regi√≥n del ", "").replace("Regi√≥n de ", "").replace("Regi√≥n ", "");
                return;
            }
            if (!row[2] || row[1].includes('PROVINCIA')) return;

            let comuna = row[2].trim();
            let direccionRaw = row.slice(3, -2).join(', ').replace(/"/g, ''); 
            let telefono = row[row.length - 2];
            let productos = row[row.length - 1].replace(/"/g, '');

            if(comuna && productos.includes('TCT')) {
                uniqueRegions.add(currentRegion);
                // Generamos un ID √∫nico simple basado en la direcci√≥n para los favoritos
                let uniqueId = btoa(unescape(encodeURIComponent(comuna + direccionRaw))).replace(/=/g, '');
                
                stations.push({
                    id: uniqueId,
                    region: currentRegion,
                    comuna: comuna,
                    direccion: direccionRaw,
                    telefono: telefono,
                    productos: productos,
                    busqueda: limpiarTexto(comuna + " " + direccionRaw)
                });
            }
        });

        populateRegionFilter();
        filtrarYRenderizar();
    }

    function populateRegionFilter() {
        const select = document.getElementById('regionFilter');
        const sortedRegions = Array.from(uniqueRegions).sort();
        sortedRegions.forEach(region => {
            const option = document.createElement('option');
            option.value = region;
            option.innerText = region;
            select.appendChild(option);
        });
    }

    // --- L√ìGICA DE TABS Y FILTROS ---
    window.switchTab = function(tab) {
        currentTab = tab;
        document.getElementById('tabSearch').className = tab === 'search' ? 'nav-tab active' : 'nav-tab';
        document.getElementById('tabFavs').className = tab === 'favs' ? 'nav-tab active' : 'nav-tab';
        
        // Ocultar controles de b√∫squeda si estamos en favoritos
        const controls = document.getElementById('searchControls');
        controls.style.display = tab === 'search' ? 'block' : 'none';

        filtrarYRenderizar();
    }

    window.toggleQuickFilter = function(servicio, elemento) {
        if (activeServiceFilter === servicio) {
            activeServiceFilter = "";
            elemento.classList.remove('active');
        } else {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            activeServiceFilter = servicio;
            elemento.classList.add('active');
        }
        filtrarYRenderizar();
    }

    // --- FAVORITOS ---
    window.toggleFavorite = function(id) {
        if (favorites.includes(id)) {
            favorites = favorites.filter(favId => favId !== id);
        } else {
            favorites.push(id);
        }
        localStorage.setItem('copecFavorites', JSON.stringify(favorites));
        filtrarYRenderizar(); // Recargar para actualizar iconos
    }

    function filtrarYRenderizar() {
        let filtered = [];

        if (currentTab === 'search') {
            const textTerm = limpiarTexto(document.getElementById('searchInput').value);
            const regionTerm = document.getElementById('regionFilter').value;
            const clearBtn = document.getElementById('clearBtn');
            clearBtn.style.display = textTerm.length > 0 ? 'block' : 'none';

            filtered = stations.filter(item => {
                const matchText = item.busqueda.includes(textTerm);
                const matchRegion = regionTerm === "" || item.region === regionTerm;
                const matchService = activeServiceFilter === "" || item.productos.includes(activeServiceFilter);
                return matchText && matchRegion && matchService;
            });
        } else {
            // Tab Favoritos
            filtered = stations.filter(item => favorites.includes(item.id));
        }

        const msg = currentTab === 'favs' && filtered.length === 0 
            ? "No tienes favoritos guardados a√∫n." 
            : `${filtered.length} locales encontrados`;
        
        document.getElementById('countInfo').innerHTML = msg;
        
        renderCards(filtered);
    }

    function renderCards(data) {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = '';
        const limit = 50;

        if (data.length === 0) {
            let icon = currentTab === 'favs' ? 'fa-star' : 'fa-map-signs';
            container.innerHTML = `<div class="no-results"><i class="fas ${icon}" style="font-size:3rem;margin-bottom:15px;color:var(--text-sec);opacity:0.5"></i><p>${currentTab === 'favs' ? 'Toca la estrella en los locales para guardarlos aqu√≠.' : 'Sin resultados.'}</p></div>`;
            return;
        }

        for (let i = 0; i < Math.min(data.length, limit); i++) {
            const item = data[i];
            const isFav = favorites.includes(item.id);
            const favClass = isFav ? 'fas is-fav' : 'far'; // fas = solido, far = contorno
            
            const mapQuery = encodeURIComponent(`Copec ${item.direccion}, ${item.comuna}`);
            const mapLink = `https://www.google.com/maps/search/?api=1&query=${mapQuery}`;
            const wspText = encodeURIComponent(`üìç Copec TCT - *${item.comuna}*\n${item.direccion}\n\nüó∫Ô∏è Mapa: ${mapLink}`);
            const wspLink = `https://wa.me/?text=${wspText}`;

            const prodTags = item.productos.split('/').map(p => {
                let cleanP = p.trim();
                let cssClass = cleanP === 'TCT' ? 'tag tag-tct' : 'tag tag-other';
                return `<span class="${cssClass}">${cleanP}</span>`;
            }).join('');

            const card = document.createElement('div');
            card.className = 'card fade-in';
            card.style.animationDelay = `${i * 0.03}s`;
            
            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <div class="card-comuna">${item.comuna}</div>
                        <div class="card-region">${item.region}</div>
                    </div>
                    <button class="fav-btn ${favClass} fa-star" onclick="toggleFavorite('${item.id}')"></button>
                </div>
                <div class="card-address">
                    <i class="fas fa-location-dot" style="color:var(--brand-red); margin-top:3px;"></i>
                    ${item.direccion}
                </div>
                <div class="card-services">${prodTags}</div>
                <div class="card-actions">
                    <a href="tel:${item.telefono}" class="btn btn-call">Llamar</a>
                    <a href="${mapLink}" target="_blank" class="btn btn-map"><i class="fas fa-location-arrow"></i> Ir</a>
                    <a href="${wspLink}" target="_blank" class="btn btn-wsp"><i class="fab fa-whatsapp"></i></a>
                </div>
            `;
            container.appendChild(card);
        }
    }

    document.getElementById('searchInput').addEventListener('keyup', filtrarYRenderizar);
    document.getElementById('regionFilter').addEventListener('change', filtrarYRenderizar);
    document.getElementById('clearBtn').addEventListener('click', function() {
        document.getElementById('searchInput').value = '';
        filtrarYRenderizar();
    });

</script>

</body>
</html>
